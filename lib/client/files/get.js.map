{"version":3,"sources":["../../../src/client/files/get.js"],"names":["opts","api","get","callbackify","variadic","files","map","file","content","getReadableStream","toStream","source","getPullStream","arguments","pull","res","PMS","name","Object","assign","post","data","deferred","defer","then","resolve","catch","err","abort"],"mappings":";;;;;;kBAUe,UAAUA,IAAV,EAAgB;AAC7B,MAAMC,MAAM;AACVC,SAAKC,sBAAYC,QAAZ,CACH,kBACE,6BAAgB,CAAhB,CADF,EAEE,uBAAa,CAAb,CAFF,EAGE,mBACE,wBAAO,gBAAP,EAAyBJ,IAAzB,CADF,EAEE,UAACK,KAAD;AAAA,aAAWA,MAAMC,GAAN,CAAU,UAACC,IAAD,EAAU;AAC7B,YAAIA,KAAKC,OAAT,EAAkB;AAChBD,eAAKC,OAAL,GAAe,4BAAeD,KAAKC,OAApB,CAAf;AACD;;AAED,eAAOD,IAAP;AACD,OANU,CAAX;AAAA,KAFF,CAHF,CADG,CADK;AAiBVE,qBAjBU,+BAiBW;AACnB,aAAOC,6BAASC,MAAT,CACL,0BACEV,IAAIW,aAAJ,YAAqBC,SAArB,CADF,EAEEC,qBAAKR,GAAL,CAAS,UAACC,IAAD,EAAU;AACjB,YAAIA,KAAKC,OAAT,EAAkB;AAChBD,eAAKC,OAAL,GAAeE,6BAASC,MAAT,CAAgBJ,KAAKC,OAArB,CAAf;AACD;AACD,eAAOD,IAAP;AACD,OALD,CAFF,CADK,CAAP;AAWD,KA7BS;;AA8BVK,mBAAgB,YAAM;AACpB,UAAMA,gBAAgB,kBACpB,6BAAgB,CAAhB,CADoB,EAEpB,uBAAa,CAAb,CAFoB,EAGpB,mBACE,wBAAO,0BAAP,EAAmCZ,IAAnC,CADF,EAEE,UAACe,GAAD;AAAA,eAAS,0BACPC,4BAAIL,MAAJ,CAAWI,IAAIE,IAAf,EAAqBjB,IAArB,CADO,EAEPc,qBAAKR,GAAL,CAAS,UAACC,IAAD,EAAU;AACjB,cAAIA,KAAKC,OAAT,EAAkB;AAChBD,iBAAKC,OAAL,GAAeQ,4BAAIL,MAAJ,CAAWJ,KAAKC,OAAL,CAAaS,IAAxB,EAA8BC,OAAOC,MAAP,CAAc,EAAd,EAAkBnB,IAAlB,EAAwB;AACnEoB,kBADmE,gBAC7DL,GAD6D,EACxD;AACT,oBAAI,0BAAaA,IAAIM,IAAjB,CAAJ,EAA4B;AAC1BN,sBAAIM,IAAJ,GAAW,4BAAeN,IAAIM,IAAnB,CAAX;AACD;;AAED,uBAAON,GAAP;AACD;AAPkE,aAAxB,CAA9B,CAAf;AASD;;AAED,iBAAOR,IAAP;AACD,SAdD,CAFO,CAAT;AAAA,OAFF,CAHoB,CAAtB;;AA0BA,aAAO,YAAa;AAClB,YAAMe,WAAWC,oBAAMZ,MAAN,EAAjB;;AAEAC,kDACGY,IADH,CACQ,UAACT,GAAD;AAAA,iBAASO,SAASG,OAAT,CAAiBV,GAAjB,CAAT;AAAA,SADR,EAEGW,KAFH,CAES,UAACC,GAAD;AAAA,iBAASL,SAASM,KAAT,CAAeD,GAAf,CAAT;AAAA,SAFT;;AAIA,eAAOL,QAAP;AACD,OARD;AASD,KApCc;AA9BL,GAAZ;;AAqEA,SAAOrB,GAAP;AACD,C;;AAjFD;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;;;AACA;;AACA;;AACA","file":"get.js","sourcesContent":["import { caller } from 'postmsg-rpc'\r\nimport callbackify from 'callbackify'\r\nimport defer from 'pull-defer'\r\nimport pull from 'pull-stream'\r\nimport toStream from 'pull-stream-to-stream'\r\nimport PMS from 'pull-postmsg-stream'\r\nimport { pre, post } from 'prepost'\r\nimport { preCidToJson } from '../../serialization/cid'\r\nimport { isBufferJson, preBufferToJson, bufferFromJson } from '../../serialization/buffer'\r\n\r\nexport default function (opts) {\r\n  const api = {\r\n    get: callbackify.variadic(\r\n      pre(\r\n        preBufferToJson(0),\r\n        preCidToJson(0),\r\n        post(\r\n          caller('ipfs.files.get', opts),\r\n          (files) => files.map((file) => {\r\n            if (file.content) {\r\n              file.content = bufferFromJson(file.content)\r\n            }\r\n\r\n            return file\r\n          })\r\n        )\r\n      )\r\n    ),\r\n    getReadableStream () {\r\n      return toStream.source(\r\n        pull(\r\n          api.getPullStream(...arguments),\r\n          pull.map((file) => {\r\n            if (file.content) {\r\n              file.content = toStream.source(file.content)\r\n            }\r\n            return file\r\n          })\r\n        )\r\n      )\r\n    },\r\n    getPullStream: (() => {\r\n      const getPullStream = pre(\r\n        preBufferToJson(0),\r\n        preCidToJson(0),\r\n        post(\r\n          caller('ipfs.files.getPullStream', opts),\r\n          (res) => pull(\r\n            PMS.source(res.name, opts),\r\n            pull.map((file) => {\r\n              if (file.content) {\r\n                file.content = PMS.source(file.content.name, Object.assign({}, opts, {\r\n                  post (res) {\r\n                    if (isBufferJson(res.data)) {\r\n                      res.data = bufferFromJson(res.data)\r\n                    }\r\n\r\n                    return res\r\n                  }\r\n                }))\r\n              }\r\n\r\n              return file\r\n            })\r\n          )\r\n        )\r\n      )\r\n\r\n      return (...args) => {\r\n        const deferred = defer.source()\r\n\r\n        getPullStream(...args)\r\n          .then((res) => deferred.resolve(res))\r\n          .catch((err) => deferred.abort(err))\r\n\r\n        return deferred\r\n      }\r\n    })()\r\n  }\r\n\r\n  return api\r\n}\r\n"]}