{"version":3,"sources":["../../src/server/dag.js"],"names":["getIpfs","opts","put","args","isBufferJson","bufferFromJson","cid","pre","dag","cidToJson","get","res","value","isBuffer","bufferToJson","tree"],"mappings":";;;;;;kBAOe,UAAUA,OAAV,EAAmBC,IAAnB,EAAyB;AACtC,SAAO;AACLC,SAAK,wBAAO,cAAP,EAAuB,kBAC1B,6BAAmB,CAAnB,CAD0B,EAE1B,YAAa;AAAA,wCAATC,IAAS;AAATA,YAAS;AAAA;;AACX;AACA,UAAIA,KAAK,CAAL,KAAW,CAAC,oBAAUA,KAAK,CAAL,CAAV,CAAhB,EAAoC;AAClCA,aAAK,CAAL,IAAU,6BAAcA,KAAK,CAAL,CAAd,EAAuBC,oBAAvB,EAAqCC,sBAArC,CAAV;AACD;;AAED,UAAIF,KAAK,CAAL,KAAWA,KAAK,CAAL,EAAQG,GAAvB,EAA4B;AAC1B,YAAI,0BAAaH,KAAK,CAAL,EAAQG,GAArB,CAAJ,EAA+B;AAC7BH,eAAK,CAAL,EAAQG,GAAR,GAAc,4BAAeH,KAAK,CAAL,EAAQG,GAAvB,CAAd;AACD,SAFD,MAEO,IAAI,oBAAUH,KAAK,CAAL,EAAQG,GAAlB,CAAJ,EAA4B;AACjCH,eAAK,CAAL,EAAQG,GAAR,GAAc,sBAAYH,KAAK,CAAL,EAAQG,GAApB,CAAd;AACD;AACF;;AAED,aAAOH,IAAP;AACD,KAjByB,EAkB1BF,KAAKM,GAAL,CAAS,SAAT,CAlB0B,EAmB1B,mBACE;AAAA;;AAAA,aAAa,0BAAUC,GAAV,EAAcN,GAAd,+BAAb;AAAA,KADF,EAEEO,cAFF,CAnB0B,CAAvB,EAuBFR,IAvBE,CADA;AAyBLS,SAAK,wBAAO,cAAP,EAAuB,kBAC1B,+BAAkB,CAAlB,CAD0B,EAE1B,yBAAe,CAAf,CAF0B,EAG1BT,KAAKM,GAAL,CAAS,SAAT,CAH0B,EAI1B,mBACE;AAAA;;AAAA,aAAa,2BAAUC,GAAV,EAAcE,GAAd,gCAAb;AAAA,KADF,EAEE,UAACC,GAAD,EAAS;AACP,UAAI,oBAAUA,IAAIC,KAAd,CAAJ,EAA0B;AACxBD,YAAIC,KAAJ,GAAY,wBAAcD,IAAIC,KAAlB,CAAZ;AACD,OAFD,MAEO,IAAI,sBAASD,IAAIC,KAAb,CAAJ,EAAyB;AAC9BD,YAAIC,KAAJ,GAAY,0BAAaD,IAAIC,KAAjB,CAAZ;AACD,OAFM,MAEA;AACLD,YAAIC,KAAJ,GAAY,6BAAcD,IAAIC,KAAlB,EAAyBC,gBAAzB,EAAmCC,oBAAnC,CAAZ;AACD;;AAED,aAAOH,GAAP;AACD,KAZH,CAJ0B,CAAvB,EAkBFV,IAlBE,CAzBA;AA4CLc,UAAM,wBAAO,eAAP,EAAwB,kBAC5B,+BAAkB,CAAlB,CAD4B,EAE5B,yBAAe,CAAf,CAF4B,EAG5Bd,KAAKM,GAAL,CAAS,UAAT,CAH4B,EAI5B;AAAA;;AAAA,aAAa,2BAAUC,GAAV,EAAcO,IAAd,gCAAb;AAAA,KAJ4B,CAAxB,EAKHd,IALG;AA5CD,GAAP;AAmDD,C;;AA3DD;;AACA;;AACA;;AACA;;AACA;;AACA","file":"dag.js","sourcesContent":["import { expose } from 'postmsg-rpc'\r\nimport { pre, post } from 'prepost'\r\nimport { isDagNode, dagNodeToJson, preDagNodeFromJson } from '../serialization/dag'\r\nimport { isCidJson, cidToJson, cidFromJson, preCidFromJson } from '../serialization/cid'\r\nimport { isBuffer, isBufferJson, bufferFromJson, preBufferFromJson, bufferToJson } from '../serialization/buffer'\r\nimport convertValues from '../serialization/utils/convert-values'\r\n\r\nexport default function (getIpfs, opts) {\r\n  return {\r\n    put: expose('ipfs.dag.put', pre(\r\n      preDagNodeFromJson(0),\r\n      (...args) => {\r\n        // TODO: CBOR node, is this correct?\r\n        if (args[0] && !isDagNode(args[0])) {\r\n          args[0] = convertValues(args[0], isBufferJson, bufferFromJson)\r\n        }\r\n\r\n        if (args[1] && args[1].cid) {\r\n          if (isBufferJson(args[1].cid)) {\r\n            args[1].cid = bufferFromJson(args[1].cid)\r\n          } else if (isCidJson(args[1].cid)) {\r\n            args[1].cid = cidFromJson(args[1].cid)\r\n          }\r\n        }\r\n\r\n        return args\r\n      },\r\n      opts.pre('dag.put'),\r\n      post(\r\n        (...args) => getIpfs().dag.put(...args),\r\n        cidToJson\r\n      )\r\n    ), opts),\r\n    get: expose('ipfs.dag.get', pre(\r\n      preBufferFromJson(0),\r\n      preCidFromJson(0),\r\n      opts.pre('dag.get'),\r\n      post(\r\n        (...args) => getIpfs().dag.get(...args),\r\n        (res) => {\r\n          if (isDagNode(res.value)) {\r\n            res.value = dagNodeToJson(res.value)\r\n          } else if (isBuffer(res.value)) {\r\n            res.value = bufferToJson(res.value)\r\n          } else {\r\n            res.value = convertValues(res.value, isBuffer, bufferToJson)\r\n          }\r\n\r\n          return res\r\n        }\r\n      )\r\n    ), opts),\r\n    tree: expose('ipfs.dag.tree', pre(\r\n      preBufferFromJson(0),\r\n      preCidFromJson(0),\r\n      opts.pre('dag.tree'),\r\n      (...args) => getIpfs().dag.tree(...args)\r\n    ), opts)\r\n  }\r\n}\r\n"]}